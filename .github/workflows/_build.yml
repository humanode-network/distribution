on:
  workflow_call:
    inputs:
      release-artifact-upload-url:
        required: false
        type: string
        description: The URL for release artifact uploads; if unset the release uploads are skipped.

defaults:
  run:
    shell: bash

jobs:
  plan:
    name: Plan the execution
    runs-on: ubuntu-24.04
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Compute matrix
        uses: ./.github/actions/plan
        id: set-matrix
        with:
          plan-name: build

  build:
    needs:
      - plan
    strategy:
      matrix: ${{ fromJson(needs.plan.outputs.matrix) }}
      fail-fast: false
    name: |-
      ${{ matrix.plan.mode.platformIndependent == true && matrix.plan.mode.name || format('{1} @ {0}', matrix.plan.platform.name, matrix.plan.mode.name) }}
    runs-on: ${{ matrix.plan.platform.os }}
    env: ${{ matrix.plan.platform.env }}
    timeout-minutes: 120
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        timeout-minutes: 5

      - uses: ./.github/actions/common-setup
        with:
          platformCacheKey: ${{ matrix.plan.platform.cacheKey }}
          modeCacheKey: ${{ matrix.plan.mode.cargoCacheKey }}
          buildEnvScript: ${{ matrix.plan.platform.buildEnvScript }}
          extraRustTargetsToInstall: ${{ join(matrix.plan.platform.extraTargetsToInstall, ' ') }}
        timeout-minutes: 10

      - name: Run cargo ${{ matrix.plan.mode.cargoCommand }}
        run: cargo ${{ matrix.plan.mode.cargoCommand }} ${{ matrix.plan.mode.cargoArgs }} ${{ matrix.plan.mode.passZigbuildTarget && matrix.plan.platform.buildTarget && format('--target={0}', matrix.plan.platform.buildTarget) || '' }}

      - name: Archive the binaries for release
        env:
          BUILD_TARGET_DIR: "target/${{ matrix.plan.platform.buildTargetDir && format('{0}/release', matrix.plan.platform.buildTargetDir) || 'release' }}"
          DEST_DIR: "target/build-archives"
          ARTIFACT_PREFIX: ""
        run: ./build-utils/archive-binaries

      - name: Compute artifact name
        env:
          ARTIFACT_NAME: |
            build-${{ runner.os }}${{ matrix.plan.platform.artifactMarker && format('-{0}', matrix.plan.platform.artifactMarker) || '' }}
        run: |
          printf "ARTIFACT_NAME=%s\n" "$ARTIFACT_NAME" >>"$GITHUB_ENV"

      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: target/build-archives/archives/*.tar.gz

      - name: Upload release archive
        uses: shogo82148/actions-upload-release-asset@v1
        if: inputs.release-artifact-upload-url != ''
        with:
          upload_url: ${{ inputs.release-artifact-upload-url }}
          asset_path: target/build-archives/archives/*.tar.gz
